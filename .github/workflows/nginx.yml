name: Configure Nginx

on:
  workflow_call:
    secrets:
      PUBLIC_IP:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_PUBLIC_KEY:
        required: true
      SSH_LOGIN_PASSWORD:
        required: true
      USERNAME:
        required: true

jobs:
  Configure-Nginx:
    name: Setup and Configure Nginx
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸŒ Execute Nginx Configuration
      run: |
        echo "ğŸŒ Starting nginx configuration..."
        echo "ğŸ”‘ Using password authentication..."
        
        # Install sshpass if needed
        if ! command -v sshpass &> /dev/null; then
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
        fi
        
        # Copy and execute nginx script
        sshpass -p "${{ secrets.SSH_LOGIN_PASSWORD }}" scp -o StrictHostKeyChecking=no ./.github/scripts/nginx.sh ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }}:/tmp/
        sshpass -p "${{ secrets.SSH_LOGIN_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }} "chmod +x /tmp/nginx.sh && sudo /tmp/nginx.sh"
        
        echo "âœ… Nginx configuration completed!"
    
    - name: ğŸ§ª Test Deployment
      run: |
        echo "ğŸ§ª Testing deployment..."
        sleep 5  # Wait for nginx to fully restart
        
        # Test localhost access
        sshpass -p "${{ secrets.SSH_LOGIN_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }} '
          echo "ğŸ“ Checking deployment files..."
          ls -la /home/tagglabs/brogrammers/
          
          echo "ğŸŒ Testing localhost access..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost || echo "âŒ Localhost test failed"
          
          echo "ğŸ“Š Nginx status check..."
          sudo systemctl status nginx --no-pager --lines=3
        '
        
        echo "âœ… Deployment test completed!"
