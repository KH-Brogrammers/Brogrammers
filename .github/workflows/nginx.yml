name: Configure Nginx

on:
  workflow_call:
    secrets:
      PUBLIC_IP:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_PUBLIC_KEY:
        required: true
      SSH_LOGIN_PASSWORD:
        required: true
      USERNAME:
        required: true

jobs:
  Configure-Nginx:
    name: Setup and Configure Nginx
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v4
    
    - name: üåê Execute Nginx Configuration
      run: |
        echo "üåê Starting nginx configuration..."
        
        if [ -f ~/.ssh/id_ed25519 ]; then
          echo "üîë Using SSH key authentication..."
          scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ./.github/scripts/nginx.sh ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }}:/tmp/
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }} "chmod +x /tmp/nginx.sh && sudo /tmp/nginx.sh"
        else
          echo "üîë Using password authentication..."
          sshpass -p "${{ secrets.SSH_LOGIN_PASSWORD }}" scp -o StrictHostKeyChecking=no ./.github/scripts/nginx.sh ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }}:/tmp/
          sshpass -p "${{ secrets.SSH_LOGIN_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.PUBLIC_IP }} "chmod +x /tmp/nginx.sh && sudo /tmp/nginx.sh"
        fi
        
        echo "‚úÖ Nginx configuration completed!"
