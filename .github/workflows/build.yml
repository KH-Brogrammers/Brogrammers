name: Build Artifacts

on:
  workflow_dispatch:
  workflow_call:  # This allows the workflow to be called from other workflows
  repository_dispatch:

jobs:
  Build:
    name: Build and Package
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Fetch last 2 commits to detect changes
    
    - name: ğŸ” Check for Changes
      id: changes
      run: |
        echo "ğŸ” DEBUG: Checking for file changes..."
        
        # Check if this is the first commit
        if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
          echo "ğŸ” DEBUG: First commit - full build required"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "reason=first-commit" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Get list of changed files
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "ğŸ” DEBUG: Changed files:"
        echo "$CHANGED_FILES" | sed 's/^/  /'
        
        # Check if any source files changed
        if echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|css|html|json|vue)$|^src/|^public/|package\.json|vite\.config|tsconfig' >/dev/null; then
          echo "ğŸ” DEBUG: Source files changed - build required"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "reason=source-changed" >> $GITHUB_OUTPUT
        else
          echo "ğŸ” DEBUG: No source files changed - using cache"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "reason=no-source-changes" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“¦ Restore Build Cache
      id: cache-restore
      uses: actions/cache/restore@v3
      with:
        path: |
          dist
          node_modules
          deployment-package
        key: build-cache-${{ runner.os }}-${{ hashFiles('package-lock.json', 'src/**/*', 'public/**/*', 'vite.config.ts', 'tsconfig.json') }}
        restore-keys: |
          build-cache-${{ runner.os }}-
    
    - name: Use Node.js
      if: steps.changes.outputs.changed == 'true' || steps.cache-restore.outputs.cache-hit != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      if: steps.changes.outputs.changed == 'true' || steps.cache-restore.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ” DEBUG: Starting npm ci..."
        npm ci
        echo "ğŸ” DEBUG: Dependencies installed successfully"
    
    - name: ğŸ—ï¸ Build Application
      if: steps.changes.outputs.changed == 'true' || steps.cache-restore.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ” DEBUG: Starting build process..."
        npm run build --if-present
        echo "ğŸ” DEBUG: Build completed"
    
    - name: ğŸ“¦ Create deployment package
      run: |
        chmod +x ./.github/scripts/build.sh
        if [ "${{ steps.changes.outputs.changed }}" == "true" ] || [ "${{ steps.cache-restore.outputs.cache-hit }}" != "true" ]; then
          echo "ğŸ” DEBUG: Creating fresh deployment package..."
          ./.github/scripts/build.sh
        else
          echo "ğŸ” DEBUG: Using cached deployment package..."
          if [ ! -d "deployment-package" ]; then
            echo "âŒ Cache miss - creating deployment package..."
            ./.github/scripts/build.sh
          fi
        fi
    
    - name: Final Security Verification
      run: |
        echo "ğŸ” FINAL SECURITY SCAN - Ensuring no source code in artifact..."
        if find "deployment-package" \( -name "*.ts" -o -name "*.tsx" -o -name "*.jsx" -o -name "src" \) 2>/dev/null | grep -q .; then
          echo "âŒ DEPLOYMENT BLOCKED: Source code detected!"
          exit 1
        fi
        echo "âœ… SECURITY CLEARED: Artifact contains only built files"
    
    - name: ğŸ’¾ Save Build Cache
      if: steps.changes.outputs.changed == 'true' || steps.cache-restore.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: |
          dist
          node_modules
          deployment-package
        key: build-cache-${{ runner.os }}-${{ hashFiles('package-lock.json', 'src/**/*', 'public/**/*', 'vite.config.ts', 'tsconfig.json') }}
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-build-${{ github.run_number }}
        path: deployment-package/
        retention-days: 7
    
    - name: Upload latest deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-build-latest
        path: deployment-package/
        retention-days: 7
        overwrite: true
    
    - name: ğŸ” DEBUG - Build Complete
      run: |
        echo "ğŸ‰ Build completed successfully! Artifact ready for deployment."
        echo "ğŸ” DEBUG: Build reason: ${{ steps.changes.outputs.reason }}"
        echo "ğŸ” DEBUG: Cache hit: ${{ steps.cache-restore.outputs.cache-hit }}"
        echo "ğŸ” DEBUG: Changes detected: ${{ steps.changes.outputs.changed }}"
        echo "ğŸ” DEBUG: Build workflow finished at $(date)"
