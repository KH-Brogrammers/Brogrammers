name: Build Artifacts

on:
  workflow_dispatch:
  workflow_call:  # This allows the workflow to be called from other workflows
  repository_dispatch:

jobs:
  Build:
    name: Build and Package
    runs-on: ubuntu-latest

    steps:
    # ğŸ“ File Listing Steps
    - name: Install tree command
      run: |
        echo "ğŸ“¦ Installing tree command..."
        sudo apt-get update
        sudo apt-get install -y tree

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for accurate builds

    - name: List repository files
      run: |
        echo "ğŸ” DEBUG: Repository contents:"
        tree -a  
    
    - name: ğŸ” DEBUG - Build Environment Info
      run: |
        echo "ğŸ” DEBUG: Build Workflow Started"
        echo "ğŸ” DEBUG: Repository: ${{ github.repository }}"
        echo "ğŸ” DEBUG: Branch: ${{ github.ref_name }}"
        echo "ğŸ” DEBUG: Commit: ${{ github.sha }}"
        echo "ğŸ” DEBUG: Actor: ${{ github.actor }}"
        echo "ğŸ” DEBUG: Event: ${{ github.event_name }}"
        echo "ğŸ” DEBUG: Workflow: ${{ github.workflow }}"
        echo "ğŸ” DEBUG: Job: ${{ github.job }}"
        echo "ğŸ” DEBUG: Runner OS: ${{ runner.os }}"
        echo "ğŸ” DEBUG: Runner Arch: ${{ runner.arch }}"
        echo "ğŸ” DEBUG: Current Directory: $(pwd)"
        echo "ğŸ” DEBUG: Available Disk Space: $(df -h . | tail -1)"
        echo "ğŸ” DEBUG: Memory Info: $(free -h)"
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: ğŸ” DEBUG - Node Environment
      run: |
        echo "ğŸ” DEBUG: Node.js version: $(node --version)"
        echo "ğŸ” DEBUG: NPM version: $(npm --version)"
        echo "ğŸ” DEBUG: NPM cache location: $(npm config get cache)"
        echo "ğŸ” DEBUG: Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ” DEBUG: Starting npm ci..."
        npm ci
        npm i
        echo "ğŸ” DEBUG: Dependencies installed successfully"
        echo "ğŸ” DEBUG: Node modules size: $(du -sh node_modules/ 2>/dev/null || echo 'N/A')"
        ls -la node_modules/ | head -20
    
    - name: ğŸ—ï¸ Build Application
      run: |
        echo "ğŸ” DEBUG: Starting build process..."
        npm run build --if-present
        echo "ğŸ” DEBUG: Build completed"
        echo "ğŸ” DEBUG: Dist directory exists: $(test -d dist && echo 'YES' || echo 'NO')"
        echo "ğŸ” DEBUG: Dist contents: $(ls -la dist/ 2>/dev/null || echo 'No dist directory')"
        tree -I dist/
    
    - name: Make build script executable
      run: |
        echo "ğŸ” DEBUG: Making build script executable..."
        chmod +x ./.github/scripts/build.sh
        echo "ğŸ” DEBUG: Build script permissions: $(ls -la ./.github/scripts/build.sh)"
    
    - name: ğŸ“¦ Create deployment package
      run: |
        echo "ğŸ” DEBUG: Starting deployment package creation..."
        ./.github/scripts/build.sh
        echo "ğŸ” DEBUG: Deployment package creation completed"
    
    - name: Final Security Verification
      run: |
        echo "ğŸ” FINAL SECURITY SCAN - Ensuring no source code in artifact..."
        if find "deployment-package" \( -name "*.ts" -o -name "*.tsx" -o -name "*.jsx" -o -name "src" \) 2>/dev/null | grep -q .; then
          echo "âŒ DEPLOYMENT BLOCKED: Source code detected!"
          exit 1
        fi
        echo "âœ… SECURITY CLEARED: Artifact contains only built files"
    
    - name: List deployment package contents BEFORE upload
      run: |
        echo "ğŸ“¦ DEPLOYMENT PACKAGE CONTENTS (BEFORE UPLOAD):"
        echo "=============================================="
        if [ -d "deployment-package" ]; then
          echo "ğŸŒ³ Tree structure:"
          find deployment-package/ -type f | sed 's|deployment-package/||' | sort | sed 's|[^/]*/|- |g'
          echo ""
          echo "ğŸ“Š File details:"
          ls -la deployment-package/
          tree deployment-package/
          echo ""
          echo "ğŸ“ˆ Total files: $(find deployment-package/ -type f | wc -l)"
        else
          echo "âŒ deployment-package directory not found!"
        fi

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-build-${{ github.run_number }}
        path: deployment-package/
        retention-days: 7
    
    - name: Upload latest deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-build-latest
        path: deployment-package/
        retention-days: 7
        overwrite: true
        
    - name: Show artifact upload confirmation
      run: |
        echo "âœ… Artifact 'deployment-build' uploaded successfully!"
        echo "ğŸ“ Path: deployment-package/"
        echo "â° Retention: 7 days"
    
    - name: ğŸ” DEBUG - Build Complete
      run: |
        echo "ğŸ‰ Build completed successfully! Artifact ready for deployment."
        echo "ğŸ” DEBUG: Build workflow finished at $(date)"
        echo "ğŸ” DEBUG: Final deployment package contents:"
        ls -la deployment-package/ 2>/dev/null || echo "No deployment package found"
        echo "ğŸ” DEBUG: Artifact upload completed"
        echo "ğŸ” DEBUG: Build job ending..."
