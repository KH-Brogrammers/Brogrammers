name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "deploy-1.0.0" ]

jobs:
  trigger-build:
    name: Trigger Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Trigger Build Workflow
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches \
          -d '{"ref":"${{ github.ref_name }}"}'
    
    - name: Wait for Build Completion
      run: |
        echo "‚è≥ Waiting for build workflow to complete..."
        sleep 30
        
        # Check build workflow status
        for i in {1..20}; do
          STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=${{ github.ref_name }}&event=workflow_dispatch" | \
            jq -r '.workflow_runs[] | select(.name=="Build Artifacts") | select(.created_at > (now - 300)) | .status' | head -1)
          
          if [ "$STATUS" = "completed" ]; then
            CONCLUSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=${{ github.ref_name }}&event=workflow_dispatch" | \
              jq -r '.workflow_runs[] | select(.name=="Build Artifacts") | select(.created_at > (now - 300)) | .conclusion' | head -1)
            
            if [ "$CONCLUSION" = "success" ]; then
              echo "‚úÖ Build completed successfully!"
              break
            else
              echo "‚ùå Build failed!"
              exit 1
            fi
          fi
          
          echo "Build status: $STATUS - waiting..."
          sleep 15
        done

  trigger-deploy:
    name: Trigger Deploy
    runs-on: ubuntu-latest
    needs: trigger-build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Trigger Deploy Workflow
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
          -d '{"ref":"${{ github.ref_name }}"}'
        
        echo "üöÄ Deploy workflow triggered successfully!"
