name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "deploy-1.0.0" ]

jobs:
  trigger-build:
    name: Trigger Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Trigger Build Workflow
      run: |
        echo "üîç DEBUG: Repository: ${{ github.repository }}"
        echo "üîç DEBUG: Branch: ${{ github.ref_name }}"
        
        # First, let's check what workflows exist
        echo "üîç DEBUG: Checking available workflows..."
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows" | \
          jq -r '.workflows[] | "\(.id): \(.name) - \(.path)"'
        
        # Try to get the workflow ID for build.yml
        WORKFLOW_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows" | \
          jq -r '.workflows[] | select(.path == ".github/workflows/build.yml") | .id')
        
        echo "üîç DEBUG: Build workflow ID: $WORKFLOW_ID"
        
        if [ "$WORKFLOW_ID" = "null" ] || [ -z "$WORKFLOW_ID" ]; then
          echo "‚ùå Build workflow not found! Available workflows:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows" | \
            jq -r '.workflows[] | "- \(.name) (\(.path))"'
          exit 1
        fi
        
        echo "üì° Triggering build workflow with ID: $WORKFLOW_ID"
        RESPONSE=$(curl -s -w "%{http_code}" -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/dispatches" \
          -d '{"ref":"${{ github.ref_name }}"}')
        
        HTTP_CODE="${RESPONSE: -3}"
        BODY="${RESPONSE%???}"
        
        echo "üîç DEBUG: HTTP Code: $HTTP_CODE"
        echo "üîç DEBUG: Response Body: $BODY"
        
        if [ "$HTTP_CODE" = "204" ]; then
          echo "‚úÖ Build workflow triggered successfully!"
        else
          echo "‚ùå Failed to trigger build workflow"
          echo "Response: $BODY"
          exit 1
        fi
    
    - name: Wait for Build Completion
      run: |
        echo "‚è≥ Waiting for build workflow to complete..."
        sleep 30
        
        # Check build workflow status
        for i in {1..20}; do
          echo "üîç DEBUG: Checking build status (attempt $i/20)..."
          
          API_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=${{ github.ref_name }}&event=workflow_dispatch")
          
          echo "üîç DEBUG: API Response length: $(echo "$API_RESPONSE" | wc -c)"
          
          STATUS=$(echo "$API_RESPONSE" | jq -r '.workflow_runs[] | select(.name=="Build Artifacts") | select(.created_at > (now - 300)) | .status' | head -1)
          
          echo "üîç DEBUG: Build status: '$STATUS'"
          
          if [ "$STATUS" = "completed" ]; then
            CONCLUSION=$(echo "$API_RESPONSE" | jq -r '.workflow_runs[] | select(.name=="Build Artifacts") | select(.created_at > (now - 300)) | .conclusion' | head -1)
            
            echo "üîç DEBUG: Build conclusion: '$CONCLUSION'"
            
            if [ "$CONCLUSION" = "success" ]; then
              echo "‚úÖ Build completed successfully!"
              break
            else
              echo "‚ùå Build failed with conclusion: $CONCLUSION"
              exit 1
            fi
          fi
          
          echo "Build status: $STATUS - waiting..."
          sleep 15
        done

  # trigger-deploy:
  #   name: Trigger Deploy
  #   runs-on: ubuntu-latest
  #   needs: trigger-build
    
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Trigger Deploy Workflow
  #     run: |
  #       curl -X POST \
  #         -H "Accept: application/vnd.github.v3+json" \
  #         -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
  #         https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
  #         -d '{"ref":"${{ github.ref_name }}"}'
        
  #       echo "üöÄ Deploy workflow triggered successfully!"
