name: Deploy to Production

on:
  workflow_call:
    secrets:
      BROGRAMMERS_VPN:
        required: true
      SSH_PASSWORD:
        required: true
      SSH_KEY:
        required: true
      USERNAME:
        required: true
      WORK_FOLDER:
        required: true

jobs:
  Deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ” DEBUG - Deploy Environment Info
      run: |
        echo "ğŸ” DEBUG: Deploy Workflow Started"
        echo "ğŸ” DEBUG: Repository: ${{ github.repository }}"
        echo "ğŸ” DEBUG: Branch: ${{ github.ref_name }}"
        echo "ğŸ” DEBUG: Commit: ${{ github.sha }}"
        echo "ğŸ” DEBUG: Work Folder: ${{ secrets.WORK_FOLDER }}"
        echo "ğŸ” DEBUG: Current Directory: $(pwd)"
    
    - name: ğŸ“¦ Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-build-latest
        path: ./deployment-package
    
    - name: ğŸ” DEBUG - Artifact Verification
      run: |
        echo "ğŸ” DEBUG: Artifact Download Complete"
        echo "ğŸ” DEBUG: Deployment Package Contents:"
        ls -la ./deployment-package/ || echo "âŒ No deployment package found"
        echo "ğŸ” DEBUG: Artifact Size:"
        du -sh ./deployment-package/ || echo "âŒ Cannot calculate size"
    
    - name: ğŸ”‘ Setup SSH with Password Authentication
      run: |
        echo "ğŸ” DEBUG: Setting up SSH with password authentication..."
        sudo apt-get update
        sudo apt-get install -y sshpass
        
        # Add server to known hosts for security
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.BROGRAMMERS_VPN }} >> ~/.ssh/known_hosts
        echo "ğŸ” DEBUG: SSH configured with host verification"
    
    - name: ğŸš€ Deploy to Server
      run: |
        echo "ğŸ” DEBUG: Starting deployment to server..."
        echo "ğŸ” DEBUG: Connecting to: ${{ secrets.BROGRAMMERS_VPN }}"
        echo "ğŸ” DEBUG: Username: ${{ secrets.USERNAME }}"
        echo "ğŸ” DEBUG: Target folder: ${{ secrets.WORK_FOLDER }}"
        
        # Create deployment package archive
        tar -czf deployment.tar.gz -C ./deployment-package .
        
        # Copy files and deploy script to server using password authentication
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp deployment.tar.gz ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp ./.github/scripts/deploy.sh ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        
        # Execute deployment script on server
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }} << 'EOF'
          echo "ğŸ” DEBUG: Connected to server successfully"
          chmod +x /tmp/deploy.sh
          WORK_FOLDER="${{ secrets.WORK_FOLDER }}" /tmp/deploy.sh
          echo "âœ… Deployment completed successfully!"
        EOF
        
        echo "ğŸ‰ Deployment to server completed!"
    
    - name: ğŸ§¹ Cleanup
      run: |
        echo "ğŸ” DEBUG: Cleaning up temporary files..."
        rm -f deployment.tar.gz
        echo "ğŸ” DEBUG: Cleanup completed"
