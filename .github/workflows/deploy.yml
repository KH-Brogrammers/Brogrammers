name: Deploy to Production

on:
  workflow_dispatch:  # Allows manual triggering
  repository_dispatch:  # Allows API triggering

jobs:
  Deploy:
    name: Deploy to Raspberry Pi
    runs-on: self-hosted
    
    steps:
    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-build
        path: /opt/app-deployment
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify artifact download
      run: |
        if [ ! -f "/opt/app-deployment/package.json" ]; then
          echo "‚ùå Error: Artifact not downloaded properly!"
          exit 1
        fi
        echo "‚úÖ Artifact downloaded successfully!"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '/opt/app-deployment/package-lock.json'
    
    - name: Install production dependencies
      run: |
        cd /opt/app-deployment
        npm ci --only=production --omit=dev
        echo "Production dependencies installed"
    
    - name: Make deploy script executable
      run: chmod +x ./.github/scripts/deploy.sh
    
    - name: Deploy to application directory
      run: ./.github/scripts/deploy.sh
    
    - name: Deployment Success
      run: echo "üéâ Deployment completed successfully! Only built artifacts are on Raspberry Pi - no source code!"