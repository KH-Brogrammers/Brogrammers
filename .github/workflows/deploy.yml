name: Deploy to Production

on:
  workflow_call:
    secrets:
      BROGRAMMERS_VPN:
        required: true
      SSH_PASSWORD:
        required: true
      SSH_KEY:
        required: true
      WORK_FOLDER:
        required: true

jobs:
  Deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ” DEBUG - Deploy Environment Info
      run: |
        echo "ğŸ” DEBUG: Deploy Workflow Started"
        echo "ğŸ” DEBUG: Repository: ${{ github.repository }}"
        echo "ğŸ” DEBUG: Branch: ${{ github.ref_name }}"
        echo "ğŸ” DEBUG: Commit: ${{ github.sha }}"
        echo "ğŸ” DEBUG: Work Folder: ${{ secrets.WORK_FOLDER }}"
        echo "ğŸ” DEBUG: Current Directory: $(pwd)"
    
    - name: ğŸ“¦ Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-build-latest
        path: ./deployment-package
    
    - name: ğŸ” DEBUG - Artifact Verification
      run: |
        echo "ğŸ” DEBUG: Artifact Download Complete"
        echo "ğŸ” DEBUG: Deployment Package Contents:"
        ls -la ./deployment-package/ || echo "âŒ No deployment package found"
        echo "ğŸ” DEBUG: Artifact Size:"
        du -sh ./deployment-package/ || echo "âŒ Cannot calculate size"
    
    - name: ğŸ”‘ Setup SSH Key
      run: |
        echo "ğŸ” DEBUG: Setting up SSH key..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.BROGRAMMERS_VPN }} >> ~/.ssh/known_hosts
        echo "ğŸ” DEBUG: SSH key configured"
    
    - name: ğŸš€ Deploy to Server
      run: |
        echo "ğŸ” DEBUG: Starting deployment to server..."
        echo "ğŸ” DEBUG: Connecting to: ${{ secrets.BROGRAMMERS_VPN }}"
        echo "ğŸ” DEBUG: Target folder: ${{ secrets.WORK_FOLDER }}"
        
        # Create deployment package archive
        tar -czf deployment.tar.gz -C ./deployment-package .
        
        # Copy files and deploy script to server
        scp -i ~/.ssh/id_rsa deployment.tar.gz root@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        scp -i ~/.ssh/id_rsa ./.github/scripts/deploy.sh root@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        
        # Execute deployment script on server
        ssh -i ~/.ssh/id_rsa root@${{ secrets.BROGRAMMERS_VPN }} << EOF
          echo "ğŸ” DEBUG: Connected to server successfully"
          chmod +x /tmp/deploy.sh
          WORK_FOLDER="${{ secrets.WORK_FOLDER }}" /tmp/deploy.sh
          echo "âœ… Deployment completed successfully!"
        EOF
        
        echo "ğŸ‰ Deployment to server completed!"
    
    - name: ğŸ§¹ Cleanup
      run: |
        echo "ğŸ” DEBUG: Cleaning up SSH keys..."
        rm -f ~/.ssh/id_rsa
        echo "ğŸ” DEBUG: Cleanup completed"
