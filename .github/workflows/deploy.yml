name: Deploy to Production

on:
  workflow_dispatch:  # Allows manual triggering
  repository_dispatch:  # Allows API triggering

jobs:
  Deploy:
    name: Deploy to Raspberry Pi
    runs-on: self-hosted
    
    steps:
    # ğŸ“ File Listing Steps
    - name: Install tree command
      run: |
        echo "ğŸ“¦ Installing tree command..."
        sudo apt-get update
        sudo apt-get install -y tree

    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-build
        path: /opt/app-deployment
        github-token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: List downloaded artifact contents
      run: |
        echo "ğŸ“¦ DOWNLOADED ARTIFACT CONTENTS:"
        ls -la /opt/app-deployment/
        tree /opt/app-deployment/

    - name: Verify artifact download
      run: |
        if [ ! -f "/opt/app-deployment/package.json" ]; then
          echo "âŒ Error: Artifact not downloaded properly!"
          exit 1
        fi
        echo "âœ… Artifact downloaded successfully!"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
        cache-dependency-path: '/opt/app-deployment/package-lock.json'
    
    - name: ğŸ” DEBUG - Node Environment
      run: |
        echo "ğŸ” DEBUG: Node.js version: $(node --version)"
        echo "ğŸ” DEBUG: NPM version: $(npm --version)"
        echo "ğŸ” DEBUG: NPM cache location: $(npm config get cache)"
        echo "ğŸ” DEBUG: Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

    - name: Install production dependencies
      run: |
        cd /opt/app-deployment
        npm ci --only=production --omit=dev
        npm i
        echo "Production dependencies installed"
        echo "ğŸ” DEBUG: Dependencies installed successfully"
        echo "ğŸ” DEBUG: Node modules size: $(du -sh node_modules/ 2>/dev/null || echo 'N/A')"
        ls -la node_modules/ | head -20
    
    - name: Make deploy script executable
      run: |
        echo "ğŸ” DEBUG: Making deploy script executable..."
        chmod +x ./.github/scripts/deploy.sh
        echo "ğŸ” DEBUG: deploy script permissions: $(ls -la ./.github/scripts/deploy.sh)"
    
    - name: Deploy to application directory
      run: ./.github/scripts/deploy.sh
    
    - name: Deployment Success
      run: echo "ğŸ‰ Deployment completed successfully! Only built artifacts are on Raspberry Pi - no source code!"