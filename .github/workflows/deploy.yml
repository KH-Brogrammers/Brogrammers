name: Deploy to Production

on:
  workflow_call:
    secrets:
      BROGRAMMERS_VPN:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_KEY:
        required: true
      USERNAME:
        required: true
      WORK_FOLDER:
        required: true

jobs:
  Deploy:
    name: Deploy to Server
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-build-latest
        path: ./deployment-package
    
    - name: ðŸ”‘ Setup SSH Keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa.pub
        chmod 600 ~/.ssh/id_rsa
        chmod 644 ~/.ssh/id_rsa.pub
    
    - name: ðŸš€ Deploy to Server
      run: |
        echo "ðŸš€ Starting deployment..."
        
        # Create deployment package
        tar -czf deployment.tar.gz -C ./deployment-package .
        
        # Copy files to server
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no deployment.tar.gz ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ./.github/scripts/deploy.sh ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }}:/tmp/
        
        # Execute deployment script
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.BROGRAMMERS_VPN }} "chmod +x /tmp/deploy.sh && WORK_FOLDER='${{ secrets.WORK_FOLDER }}' /tmp/deploy.sh"
        
        echo "âœ… Deployment completed!"
    
    - name: ðŸ§¹ Cleanup
      run: |
        rm -f deployment.tar.gz
        rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
